<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Drawflow</title>
</head>

<body>
  <script src="dist/drawflow.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"
    integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="dist/drawflow.min.css" />
  <link rel="stylesheet" type="text/css" href="docs/beautiful.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
    integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>


  <div class="wrapper">
    <header class="header">

      <div class="bar-zoom">
        <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
        <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
        <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
      </div>

      <div class="group-wrapper">

        <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="PHRASE">
          <img class="block-image" src="./images/phrase.png" alt="phrase"><span>Фраза</span>
        </div>

        <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ANSWER">
          <img class="block-image" src="./images/answer.png" alt="answer"><span>Ответ</span>
        </div>

        <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="SMS">
          <img class="block-image" src="./images/sms.png" alt="SMS"><span>SMS</span>
        </div>

      </div>

      <div class="group-wrapper">
        <button onclick="editor.clearModuleSelected()"><img class="clear-img" src="./images/clear.png" /></button>
        <button id="btn-download-json-file"><img class="export-img" src="./images/export.png" /></button>

        <button class="input__wrapper">
          <input type="file" name="files" id="files" class="input__file" multiple ccept=".json">
          <label for="files"><img class="input__file-icon" src="./images/import.png" alt="Выбрать файл" width="30"
              height="30" /></label>
        </button>

      </div>

    </header>

    <div class="col-right">

      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
      </div>
    </div>

    <div class="to-close-right-modal hide">
      <div class="right-modal hide">

        <span class="btn-close-right-modal">CLOSE</span>

        <button class="delete-block">Удалить блок</button>

        <div class="right-modal-content"></div>
      </div>
    </div>

  </div>

  <script>
    var id = document.getElementById("drawflow");
    const editor = new Drawflow(id);
    editor.start();

    let blockId;
    let typeOfRightModal; // phrase, answer, sms

    const refs = {
      rightModal: document.querySelector('.right-modal'),
      closeRightModal: document.querySelector('.btn-close-right-modal'),
      deleteBlock: document.querySelector('.delete-block'),
      rightModalContent: document.querySelector('.right-modal-content'),
      btnSaveInJson: document.querySelector('#btn-download-json-file'),
      toCloseRightModal: document.querySelector('.to-close-right-modal'),
    };
    // so that the right modal close when you click past it:
    refs.toCloseRightModal.addEventListener('click', (e) => {
      if (e.target === refs.toCloseRightModal) {
        closeRightModal();
      };
    });

    function closeRightModal(e) {
      // so that changes are saved when you close the module:
      changeCurrentNode();

      refs.toCloseRightModal.classList.toggle('hide');
      refs.rightModal.classList.add('hide');
      refs.rightModal.removeEventListener('click', closeRightModal);
      refs.deleteBlock.removeEventListener('click', deleteCurrentBlock);
      refs.rightModalContent.innerHTML = '';
      refs.deleteBlock.removeEventListener('click', deleteCurrentBlock);
      blockId = null;
      typeOfRightModal = null;
    }

    function deleteCurrentBlock() {
      editor.removeNodeId('node-' + blockId);
      closeRightModal();
    }

    function addNodeContentToRightModal(id) {
      blockId = id;
      let exportdata = editor.export();
      console.log('exportdata in addNodeContentToRightModal when openRightModal');
      console.dir(exportdata);

      if (typeOfRightModal === "phrase") {
        let title = exportdata.drawflow.Home.data[blockId].data.title;
        let text = exportdata.drawflow.Home.data[blockId].data.text;
        let is_final = exportdata.drawflow.Home.data[blockId].data.files.is_final;
        refs.rightModalContent.innerHTML = `
        <div class="phrase-content">
          <h2>Фраза</h2>
          <label for="title">Название:</label>
          <input id="title" type="text" value="${title}">
          <label for="text">Текст:</label>
          <input id="text" type="text" value="${text}">
          <label for="audiofile">Аудио:</label>
          <input id="audiofile" type="file">
          <label for="final-input"><input id="final-input" type="checkbox"> Финальное</label>
        </div>
        `;
        if (is_final) {
          refs.rightModalContent.querySelector('#final-input').setAttribute('checked', true);
        }
      } else if (typeOfRightModal === "answer") {
        let title = exportdata.drawflow.Home.data[blockId].data.title;
        let type = exportdata.drawflow.Home.data[blockId].data.type;
        console.log('type answer in addNodeContentToRightModal', type);

        if (type === "" || type === "Тишина" || type === "Непонятно" || type === "Открытый вопрос") {
          refs.rightModalContent.innerHTML = `
        <div class="answer-content">
          <h2>Ответ</h2>
          <label for="title">Тип:</label>
          <select size="1">
            <option disabled>Выберите тип</option>
            <option value="Непонятно">Непонятно</option>
            <option value="Тишина">Тишина</option>
            <option value="Открытый вопрос">Открытый вопрос</option>
            <option value="Интент">Интент</option>
          </select>
          <label for="title">Название:</label>
          <input id="title" type="text" value="${title}">
        </div>
        `;
          if (type !== "") {
            refs.rightModalContent.querySelector('select').querySelector(`option[value="${type}"]`).setAttribute(
              'selected', true);
          };
        }

        if (type === "Интент") {
          let intents = exportdata.drawflow.Home.data[blockId].data.intents;
          refs.rightModalContent.innerHTML = `
            <div class="answer-content">
              <h2>Ответ</h2>
              <label for="title">Тип:</label>
              <select size="1">
                <option disabled>Выберите тип</option>
                <option value="Непонятно">Непонятно</option>
                <option value="Тишина">Тишина</option>
                <option value="Открытый вопрос">Открытый вопрос</option>
                <option selected value="Интент">Интент</option>
              </select>
              <label for="title">Название:</label>
              <input id="title" type="text" value="${title}">
              <label for="textarea">Свои интенты:</label>
              <textarea id="textarea" type="text" value="${title}">${intents}</textarea>
              <p id="intents">
                <span>Да</span>
                <span>Нет</span>
                <span>Вопрос</span>
                <span>Повторите</span>
              </p>
            </div>
            `;
          refs.rightModalContent.querySelector('#intents').addEventListener('click', addIntentsToRightModalTextArea);
        }

      } else if (typeOfRightModal === "sms") {
        let title = exportdata.drawflow.Home.data[blockId].data.title;
        let text = exportdata.drawflow.Home.data[blockId].data.text;
        refs.rightModalContent.innerHTML = `
        <div class="sms-content">
          <h2>SMS</h2>
          <label for="title">Название:</label>
          <input id="title" type="text" value="${title}">
          <label for="text">Текст:</label>
          <input id="text" type="text" value="${text}">
        </div>
        `;
      }

      // const content = document.querySelector('#node-' + id).querySelector('.drawflow_content_node').innerHTML;
      // refs.rightModalContent.innerHTML = "";
      // refs.rightModalContent.insertAdjacentHTML('beforeend', content)
    }

    function addIntentsToRightModalTextArea(e) {
      if (e.target.tagName !== "SPAN") return;
      if (refs.rightModalContent.querySelector('textarea').textContent.length === 0) {
        refs.rightModalContent.querySelector('textarea').textContent = e.target.textContent;
      } else {
        refs.rightModalContent.querySelector('textarea').textContent += `, ${e.target.textContent}`;
      }
    }

    function changeCurrentNode() {
      let exportdata = editor.export();
      console.log('exportdata before change:>> ', exportdata);
      console.log('id :>> ', blockId);
      //console.log('typeOfRightModal :>> ', typeOfRightModal);
      //let typeOfRightModal; // phrase, answer, sms
      if (typeOfRightModal === "phrase") {
        const title = refs.rightModalContent.querySelector('input[id="title"]').value;
        exportdata.drawflow.Home.data[blockId].html =
          `<p class="block-title" data-typeofrightmodal="phrase" data-id=${blockId}>${title}</p>`;
        exportdata.drawflow.Home.data[blockId].data.title = title;
        const text = refs.rightModalContent.querySelector('input[id="text"]').value;
        exportdata.drawflow.Home.data[blockId].data.text = text;
        const is_final = refs.rightModalContent.querySelector('input[id="final-input"]').checked;
        console.log('is_final');
        console.dir(is_final);
        exportdata.drawflow.Home.data[blockId].data.files.is_final = is_final;
      } else if (typeOfRightModal === "answer") {
        const title = refs.rightModalContent.querySelector('input[id="title"]').value;
        exportdata.drawflow.Home.data[blockId].html =
          `<p class="block-title" data-typeofrightmodal="answer" data-id=${blockId}>${title}</p>`;
        exportdata.drawflow.Home.data[blockId].data.title = title;
        let type = refs.rightModalContent.querySelector('select').value;
        exportdata.drawflow.Home.data[blockId].data.type = type;
      }

      console.log('exportdata after change :>> ', exportdata);
      editor.import(exportdata);
      addEventListenerOnBlockTitles();
    };

    // code for export data in my-download.json - start
    const saveData = (function () {
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      return function (data, fileName) {
        var json = JSON.stringify(data),
          blob = new Blob([json], {
            type: "octet/stream"
          }),
          url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = fileName;
        a.click();
        window.URL.revokeObjectURL(url);
      };
    }());

    function onSaveDataInFileJson() {
      const data = editor.export();
      const json = JSON.stringify(data);
      const fileName = "my-download.json";
      saveData(json, fileName);
    }
    refs.btnSaveInJson.addEventListener('click', onSaveDataInFileJson);
    // code for export data in my-download.json - end

    // code for import data from someFile.json - start
    function handleFileSelect(evt) {
      try {
        const file = document.getElementById('files').files.item(0);
        const reader = new FileReader();
        reader.onload = function () {
          const data = JSON.parse(JSON.parse(reader.result));
          editor.import(data);
        }
        reader.readAsText(file);
      } catch (error) {
        alert('The following error occurred: ' + error + '. Try again');
      }
    }
    document.getElementById('files').addEventListener('change', handleFileSelect, false);
    // code for import data from someFile.json - end

    function openRightModal(e) {
      blockId = e.target.dataset.id;
      typeOfRightModal = e.target.dataset.typeofrightmodal;
      console.log('typeOfRightModal when openRightModal:>> ', typeOfRightModal);
      refs.deleteBlock.removeEventListener('click', deleteCurrentBlock);
      refs.rightModal.classList.remove('hide');
      refs.closeRightModal.addEventListener('click', closeRightModal);
      refs.deleteBlock.addEventListener('click', deleteCurrentBlock);

      addNodeContentToRightModal(blockId);

      // addEditableAtributeToAllContent();

      refs.toCloseRightModal.classList.toggle('hide');
    }

    function addEventListenerOnBlockTitles() {
      const blockTitles = document.querySelectorAll('.block-title');
      if (blockTitles.length === 0) return;
      blockTitles.forEach(element => {
        element.addEventListener('click', openRightModal);
      });
    }

    // Events!
    editor.on('nodeCreated', function (id) {
      // console.log("Node created " + id);
      const blockId = '#node-' + id;
      const blockTitle = document.querySelector(blockId).querySelector('.block-title');
      blockTitle.setAttribute('data-id', id);

      addEventListenerOnBlockTitles();
    })
    editor.on('nodeRemoved', function (id) {
      console.log("Node removed " + id);
      closeRightModal();
    })
    editor.on('nodeSelected', function (id) {

    })
    editor.on('moduleCreated', function (name) {
      console.log("Module Created " + name);
    })
    editor.on('moduleChanged', function (name) {
      console.log("Module Changed " + name);
    })
    editor.on('connectionCreated', function (connection) {
      console.log('Connection created');
      console.log(connection);
    })
    editor.on('connectionRemoved', function (connection) {
      console.log('Connection removed');
      console.log(connection);
    })
    editor.on('mouseMove', function (position) {
      // console.log('Position mouse x:' + position.x + ' y:' + position.y);
    })
    editor.on('zoom', function (zoom) {
      console.log('Zoom level ' + zoom);
    })
    editor.on('translate', function (position) {
      console.log('Translate x:' + position.x + ' y:' + position.y);
    })

    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false);
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;

    function positionMobile(ev) {
      mobile_last_move = event;
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
        ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0]
          .clientY).closest("#drawflow");
        if (parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0]
            .clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }

    }

    function addNodeToDrawFlow(name, pos_x, pos_y) {
      if (editor.editor_mode === 'fixed') {
        return false;
      }
      pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas
        .getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
      pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor
        .precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight *
          editor.zoom)));

      switch (name) {
        case 'PHRASE':
          var PHRASE = `
          <p class="block-title" data-typeofrightmodal="phrase">Фраза</p>
        `;
          editor.addNode('PHRASE', 1, 1, pos_x, pos_y, 'phrase', {
            title: "Фраза",
            text: "",
            files: {
              name: "",
              type: "",
              link: "",
              is_final: false,
            }
          }, PHRASE);
          break;

        case 'ANSWER':
          var ANSWER = `
          <p class="block-title" data-typeofrightmodal="answer">Ответ</p>
          `
          editor.addNode('ANSWER', 1, 1, pos_x, pos_y, 'answer', {
            title: "Ответ",
            type: "Интент",
            intents: "",
          }, ANSWER);
          break;

        case 'SMS':
          var SMS = `
          <p class="block-title" data-typeofrightmodal="sms">SMS</p>
          `;
          editor.addNode('SMS', 1, 1, pos_x, pos_y, 'sms', {
            title: "SMS",
            text: "",
          }, SMS);
          break;

        default:
      }
    }

    var transform = '';

    function showpopup(e) {
      e.target.closest(".drawflow-node").style.zIndex = "9999";
      e.target.children[0].style.display = "block";
      //document.getElementById("modalfix").style.display = "block";

      //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
      transform = editor.precanvas.style.transform;
      editor.precanvas.style.transform = '';
      editor.precanvas.style.left = editor.canvas_x + 'px';
      editor.precanvas.style.top = editor.canvas_y + 'px';
      console.log(transform);

      //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
      //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
      editor.editor_mode = "fixed";

    }

    function closemodal(e) {
      e.target.closest(".drawflow-node").style.zIndex = "2";
      e.target.parentElement.parentElement.style.display = "none";
      //document.getElementById("modalfix").style.display = "none";
      editor.precanvas.style.transform = transform;
      editor.precanvas.style.left = '0px';
      editor.precanvas.style.top = '0px';
      editor.editor_mode = "edit";
    }
  </script>
</body>

</html>